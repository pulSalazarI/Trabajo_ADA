{% extends "base.html" %}

{% block title %}Mapa de Puntos de Basura{% endblock %}

{% block content %}
<style>
    .layout-mapa {
        display: flex;
        height: 100%;
        min-height: 100%;
        width: 100%;
    }
    .sidebar-izquierda {
        width: 320px;
        background: #295003;
        box-shadow: 2px 0 10px rgba(0,0,0,0.08);
        padding: 0;
        overflow-y: auto;
        z-index: 10;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center; /* Centra verticalmente el contenido */
    }
    .perfil-container {
        margin-top: 0;
        margin-bottom: 0;
        align-self: center;
    }
    .main-mapa {
        flex: 1;
        position: relative;
        height: 100%;
        min-width: 0;
        background: #fff;
        display: flex;
        flex-direction: column;
    }
    #map {
        width: 100%;
        height: 100%;
        min-height: 0;
        flex: 1;
    }
    html, body, .main-content {
        height: 100%;
        min-height: 100%;
    }
    /* Leaflet zoom control fix */
    .leaflet-control-container .leaflet-top.leaflet-left {
        top: 90px !important; /* Baja el control debajo del header */
        left: 10px !important;
    }
    .sidebar-derecho {
        width: 320px;
        opacity: 100%;
        background: #0e0e0e;
        box-shadow: -2px 0 10px rgb(191, 22, 22);
        padding: 0;
        overflow-y: auto;
        z-index: 10;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: static;
        border: none !important;
        box-shadow: none !important;
        transition: none !important;
    }
    #detalleBasuraContent {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: stretch;
        justify-content: stretch;
    }
</style>
<div class="layout-mapa">
    <aside class="sidebar-izquierda">
        {% include "ctn_perfil.html" %}
    </aside>
    <main class="main-mapa">
        <div id="map"></div>
        <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
        <script src="{{ url_for('static', filename='script.js') }}"></script>
    </main>
    <aside class="sidebar-derecho" id="sidebarDerecho">
        <div id="detalleBasuraContent" style="height: 100%; display: flex; align-items: center; justify-content: center;">
            <span id="mensaje-inicial-detalle" style="color: #ffe066; font-size: 1.15rem; text-align: center;">Seleccione un punto de basura para Recolectar y cobrar la recompensa</span>
        </div>
    </aside>
</div>
<script>
window.addEventListener('mostrarDetalleBasura', function(e) {
    const sidebar = document.getElementById('sidebarDerecho');
    // Asegura que el sidebar esté visible
    sidebar.style.display = 'flex';
    // Evita recargar el componente si ya está cargado para el mismo punto
    const currentDetalle = document.getElementById('detalleBasuraContent');
    if (currentDetalle && currentDetalle.getAttribute('data-id') == e.detail.puntoId) {
        // Ya está cargado el detalle para este punto, no recargar
        return;
    }
    fetch('/detalle_basura')
        .then(res => res.text())
        .then(html => {
            document.getElementById('detalleBasuraContent').innerHTML = html;
            document.getElementById('detalleBasuraContent').setAttribute('data-id', e.detail.puntoId);
            // Dispara solo el evento detalleBasuraIdSeleccionado
            if (e.detail && e.detail.puntoId) {
                setTimeout(() => {
                    window.dispatchEvent(new CustomEvent('detalleBasuraIdSeleccionado', { detail: { id_p_basura: e.detail.puntoId } }));
                }, 50);
            }
        });
});
</script>
{% endblock %}

{% block head_styles %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
{% endblock %}
